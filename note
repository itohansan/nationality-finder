const resolvers = {
  Query: {
    async getNationality(_, { name }) {
      console.log("getNationality called with:", name);

      // Normalize input
      const normalize = (str) =>
        str
          .toLowerCase()
          .trim()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");

      const normalized = normalize(name);

      // Remove common job titles
      let cleanedName = normalized
        .replace(
          /\b(singer|artist|rapper|musician|actor|actress|player|footballer|dj|producer|celeb)\b/g,
          ""
        )
        .trim();

      console.log(`Input: "${name}" ‚Üí cleaned: "${cleanedName}"`);

      // Quick cache (instant rich results)
      const quickCache = {
        rema: {
          name,
          nationality: "NG",
          fullName: "Divine Ikubor",
          age: 25,
          occupation: ["Singer", "Rapper", "Songwriter"],
          photo:
            "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Rema_%28musician%29.jpg/800px-Rema_%28musician%29.jpg",
          bio: "Nigerian Afrobeats superstar known for 'Calm Down' and global hits.",
        },
        wizkid: {
          name,
          nationality: "NG",
          fullName: "Ayodeji Ibrahim Balogun",
          age: 34,
          occupation: ["Singer", "Songwriter"],
          photo:
            "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5f/Wizkid_performing_in_2019.jpg/800px-Wizkid_performing_in_2019.jpg",
          bio: "Nigerian music icon and pioneer of Afrobeats worldwide.",
        },
        tems: {
          name,
          nationality: "NG",
          fullName: "Temilade Openiyi",
          age: 29,
          occupation: ["Singer", "Songwriter"],
          photo:
            "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6e/Tems_2022.jpg/800px-Tems_2022.jpg",
          bio: "Nigerian alt√©/R&B singer who rose to fame with 'Essence' alongside Wizkid.",
        },
      };

      if (quickCache[cleanedName]) {
        console.log("Quick cache hit!");
        return quickCache[cleanedName];
      }

      // Smart name corrections
      const nameCorrections = {
        "the weekend": "the weeknd",
        weeknd: "the weeknd",
        "abel tesfaye": "the weeknd",
        beyonce: "beyonc√©",
        "post malone": "post malone",
        "billie eilish": "billie eilish",
        "ariana grande": "ariana grande",
        "justin bieber": "justin bieber",
        "ed sheeran": "ed sheeran",
        "taylor swift": "taylor swift",
        "elon musk": "elon musk",
      };

      let searchName = nameCorrections[cleanedName] || cleanedName;
      console.log("Final search name ‚Üí", searchName);

      // 1. API-NINJAS (Best source)
      try {
        console.log("Searching API Ninjas...");
        const apiKey = process.env.API_NINJAS_KEY;

        if (!apiKey) throw new Error("API key missing");

        const response = await fetch(
          `https://api.api-ninjas.com/v1/celebrity?name=${encodeURIComponent(
            searchName
          )}`,
          { headers: { "X-Api-Key": apiKey } }
        );

        if (response.ok) {
          const data = await response.json();
          console.log("API Ninjas response:", data);

          if (data?.length > 0) {
            let celeb = data[0];

            // Prefer musicians if query suggests music
            if (name.match(/sing|music|rap|dj|artist/i)) {
              const musician = data.find((c) =>
                c.occupation?.some((o) =>
                  /singer|musician|rapper|dj|artist/i.test(o)
                )
              );
              if (musician) celeb = musician;
            }

            const nationality = celeb.nationality?.toUpperCase();

            if (nationality) {
              const occupations = (celeb.occupation || [])
                .map((o) =>
                  o
                    .split("_")
                    .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
                    .join(" ")
                )
                .filter((o) => !o.toLowerCase().includes("porn"));

              // Get photo from Wikipedia
              // GET PHOTO FROM WIKIPEDIA (FIXED)
              let photoUrl = null;
              try {
                const properTitle = celeb.name
                  .toLowerCase()
                  .split(" ")
                  .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
                  .join(" ");

                console.log("Searching Wikipedia photo for:", properTitle);

                const wikiRes = await fetch(
                  `https://en.wikipedia.org/w/api.php?action=query&prop=pageimages&format=json&piprop=original&titles=${encodeURIComponent(
                    properTitle
                  )}&origin=*`
                );
                const wikiData = await wikiRes.json();
                const page = Object.values(wikiData.query.pages)[0];
                if (page?.original?.source) {
                  photoUrl = page.original.source;
                  console.log("PHOTO FOUND:", photoUrl);
                } else {
                  console.log("No photo on Wikipedia page");
                }
              } catch (e) {
                console.log("Wikipedia photo fetch failed");
              }

              return {
                name,
                nationality,
                fullName: celeb.name,
                age: celeb.age || null,
                occupation: occupations,
                photo: photoUrl,
                bio: `${celeb.name} is known for ${
                  occupations[0] || "their work in entertainment"
                }.`,
              };
            }
          }
        }
      } catch (err) {
        console.error("API Ninjas failed:", err.message);
      }

      // 2. MusicBrainz fallback
      try {
        console.log("Trying MusicBrainz...");
        const mbRes = await fetch(
          `https://musicbrainz.org/ws/2/artist/?query=${encodeURIComponent(
            searchName
          )}&fmt=json&limit=3`,
          { headers: { "User-Agent": "NationalityApp/1.0" } }
        );
        if (mbRes.ok) {
          const mbData = await mbRes.json();
          if (mbData.artists?.length > 0) {
            const artist = mbData.artists[0];
            if (artist.country) {
              let age = null;
              if (artist["life-span"]?.begin) {
                age =
                  new Date().getFullYear() -
                  parseInt(artist["life-span"].begin);
              }
              return {
                name,
                nationality: artist.country,
                fullName: artist.name,
                age,
                occupation: ["Musician", "Artist"],
                photo: null,
                bio: artist.disambiguation || null,
              };
            }
          }
        }
      } catch (err) {
        console.error("MusicBrainz failed");
      }

      // 3. Final fallback: Nationalize.io
      try {
        const res = await fetch(
          `https://api.nationalize.io/?name=${encodeURIComponent(
            name.split(" ")[0]
          )}`
        );
        const data = await res.json();
        if (data.country?.[0]) {
          return {
            name,
            nationality: data.country[0].country_id,
            fullName: null,
            age: null,
            occupation: [],
            photo: null,
            bio: null,
          };
        }
      } catch (err) {
        console.error("Nationalize.io failed");
      }

      // Unknown
      return {
        name,
        nationality: "Unknown",
        fullName: null,
        age: null,
        occupation: [],
        photo: null,
        bio: null,
      };
    },
  },
};

export default resolvers;

// export const resolvers = {
//   Query: {
//     getNationality: (_, { name }) => {
//       const data = {
//         "elon musk": "South African",
//         rihanna: "Barbadian",
//         "cristiano ronaldo": "Portuguese",
//         drake: "Canadian",
//       };

//       const nationality = data[name.toLowerCase()];

//       if (!nationality) return null;

//       return {
//         name,
//         nationality,
//       };
//     },
//   },
// };

// export const resolvers = {
//   Query: {
//     getNationality: async (__dirname, { name }) => {
//       const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(
//         name
//       )}`;

//       const response = await fetch(url);
//       const data = await response.json();

//       if (!data.extract) return null;

//       const match = data.extract.match(/is an? ([A-Za-z]+) [a-zA-Z] +/);

//       if (!match) return null;

//       return {
//         name,
//         nationality: match[1],
//       };
//     },
//   },
// };

// export const resolvers = {
//   Query: {
//     getNationality: async (_, { name }) => {
//       console.log("INPUT NAME:", name, "TYPE:", typeof name);
//       try {
//         // Step 1: Wikipedia search (with better encoding)
//         const searchRes = await fetch(
//           `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(
//             name
//           )}&srlimit=10&format=json&origin=*`
//         );
//         const searchJson = await searchRes.json();
//         const results = searchJson.query?.search || [];

//         // Smart page selection
//         let pageTitle =
//           results.find((r) => r.title.toLowerCase() === name.toLowerCase())
//             ?.title ||
//           results.find((r) => {
//             const lower = (r.snippet || "").toLowerCase();
//             return (
//               r.title
//                 .toLowerCase()
//                 .includes(name.toLowerCase().replace(/[^a-z]/g, "")) &&
//               (lower.includes("born") ||
//                 lower.includes("singer") ||
//                 lower.includes("rapper") ||
//                 lower.includes("footballer") ||
//                 lower.includes("actor"))
//             );
//           })?.title ||
//           results[0]?.title;

//         if (!pageTitle) return fallbackNationality(name);

//         // Step 2: Get Wikidata ID
//         const pageRes = await fetch(
//           `https://en.wikipedia.org/w/api.php?action=query&prop=pageprops&titles=${encodeURIComponent(
//             pageTitle
//           )}&format=json&origin=*`
//         );
//         const pageJson = await pageRes.json();
//         const page = Object.values(pageJson.query.pages)[0];
//         const wikidataId = page.pageprops?.wikibase_item;

//         if (!wikidataId) {
//           console.log("No Wikidata ID found");
//           return fallbackNationality(name);
//         }

//         // Step 3: Fetch nationality from Wikidata
//         const wdRes = await fetch(
//           `https://www.wikidata.org/w/api.php?action=wbgetentities&ids=${wikidataId}&props=claims&format=json&origin=*`
//         );
//         const wdJson = await wdRes.json();
//         const claims = wdJson.entities[wikidataId]?.claims?.P27;

//         if (!claims || claims.length === 0) {
//           console.log("No citizenship claims found");
//           return fallbackNationality(name);
//         }

//         // Step 4: Get country labels
//         const countryIds = claims.map((c) => c.mainsnak.datavalue.value.id);
//         const labelsRes = await fetch(
//           `https://www.wikidata.org/w/api.php?action=wbgetentities&ids=${countryIds.join(
//             "|"
//           )}&props=labels&languages=en&format=json&origin=*`
//         );
//         const labelsJson = await labelsRes.json();

//         const nationalities = countryIds
//           .map((id) => labelsJson.entities[id]?.labels?.en?.value)
//           .filter(Boolean);

//         console.log(`Success for ${name}: ${nationalities}`);

//         return {
//           name,
//           nationality: nationalities[0] || null,
//           allNationalities: nationalities,
//           wikidataId,
//           wikipediaTitle: pageTitle,
//         };
//       } catch (error) {
//         console.error("Error in getNationality:", error);
//         return fallbackNationality(name);
//       }
//     },
//   },
// };

// // Fallback: Name-based guess via Nationalize.io
// async function fallbackNationality(name) {
//   try {
//     const firstName = name.split(" ")[0];
//     const url = `https://api.nationalize.io/?name=${encodeURIComponent(
//       firstName
//     )}`;
//     const res = await fetch(url);
//     const data = await res.json();
//     const best = data.country?.[0];

//     if (!best) return { name, nationality: null, source: "fallback" };

//     const countryMap = {
//       FR: "France",
//       US: "United States",
//       GB: "United Kingdom",
//       DE: "Germany",
//       BR: "Brazil",
//       AR: "Argentina",
//       PT: "Portugal",
//       NG: "Nigeria",
//       IN: "India",
//       // Add more; for Mbapp√© (Kylian), it guesses FR ~0.85 probability
//     };

//     return {
//       name,
//       nationality: countryMap[best.country_id] || null,
//       probability: best.probability,
//       source: "nationalize.io (fallback)",
//     };
//   } catch (error) {
//     console.error("Fallback failed:", error);
//     return { name, nationality: null, source: "error" };
//   }
// }

// const resolvers = {
//   Query: {
//     async getNationality(_, { name }) {
//       const url = `https://api.nationalize.io/?name=${encodeURIComponent(
//         name
//       )}`;

//       const response = await fetch(url);
//       const data = await response.json();

//       if (!data.country || data.country.length === 0) {
//         return {
//           name,
//           nationality: "Unknown",
//         };
//       }

//       // Pick the country with highest probability
//       const top = data.country[0];

//       return {
//         name,
//         nationality: top.country_id, // e.g. "US", "NG", "GB"
//       };
//     },
//   },
// };

// export default resolvers;

// function safeGet(obj, path, fallback = null) {
//   return path.reduce((acc, key) => (acc && acc[key] !== undefined ? acc[key] : fallback), obj);
// }

// async function wikidataSearch(name) {
//   const url = `https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encodeURIComponent(
//     name
//   )}&language=en&format=json&limit=1`;
//   const res = await fetch(url);
//   if (!res.ok) return null;
//   const json = await res.json();
//   return json?.search?.[0]?.id ?? null;
// }

// async function wikidataGetNationality(entityId) {
//   const url = `https://www.wikidata.org/wiki/Special:EntityData/${encodeURIComponent(entityId)}.json`;
//   const res = await fetch(url);
//   if (!res.ok) return null;
//   const json = await res.json();

//   const ent = json?.entities?.[entityId];
//   if (!ent) return null;

//   // P27 = country of citizenship
//   const p27 = ent.claims?.P27?.[0];
//   const countryId = safeGet(p27, ["mainsnak", "datavalue", "value", "id"], null);
//   if (!countryId) return null;

//   // country label (e.g., "Nigeria")
//   const countryLabel = json.entities?.[countryId]?.labels?.en?.value ?? null;
//   return countryLabel || null;
// }

// export const resolvers = {
//   Query: {
//     async getNationality(_, { name }) {
//       // 1) Try Wikidata (best accuracy)
//       try {
//         const entityId = await wikidataSearch(name);
//         if (entityId) {
//           const country = await wikidataGetNationality(entityId);
//           if (country) return { name, nationality: country };
//         }
//       } catch (e) {
//         // ignore and fall back
//       }

//       // 2) Fallback: nationalize.io (probabilistic)
//       try {
//         const url = `https://api.nationalize.io/?name=${encodeURIComponent(name)}`;
//         const response = await fetch(url);
//         const data = await response.json();
//         if (data?.country?.length) {
//           return { name, nationality: data.country[0].country_id };
//         }
//       } catch (e) {
//         // ignore
//       }

//       return { name, nationality: "Unknown" };
//     },
//   },
// };

// export default resolvers;
// export const resolvers = {
//   Query: {
//     async getNationality(_, { name }) {
//       const lower = name.toLowerCase().trim();
//       const knownPeople = {
//         rema: "Nigeria",
//         wizkid: "Nigeria",
//         rihanna: "Barbados",
//         "cristiano ronaldo": "Portugal",
//         drake: "Canada",
//       };

//       if (knownPeople[lower]) {
//         return { name, nationality: knownPeople[lower] };
//       }

//       // Fallback to Nationalize.io for unknown names
//       try {
//         const url = `https://api.nationalize.io/?name=${encodeURIComponent(
//           name
//         )}`;
//         const res = await fetch(url);
//         const data = await res.json();

//         if (data?.country?.length) {
//           return { name, nationality: data.country[0].country_id };
//         }
//       } catch (err) {}

//       return { name, nationality: "Unknown" };
//     },
//   },
// };

// export default resolvers;

// Log immediately to verify this file is being loaded
//

// Log immediately to verify this file is being loaded
// console.log("üîÑ Nationality resolver loaded at:", new Date().toISOString());

// const resolvers = {
//   Query: {
//     async getNationality(_, { name }) {
//       console.log("üéØ getNationality called with:", name);

//       // Normalize: lowercase, trim, remove accents/special chars
//       const normalize = (str) => {
//         return str
//           .toLowerCase()
//           .trim()
//           .normalize("NFD")
//           .replace(/[\u0300-\u036f]/g, ""); // Remove accents
//       };

//       const normalized = normalize(name);
//       console.log("üìù Normalized input:", `"${name}" -> "${normalized}"`);

//       // Known people cache (using ISO country codes)
//       const knownPeople = {
//         rema: "NG",
//         wizkid: "NG",
//         tems: "NG",
//         burna: "NG",
//         "burna boy": "NG",
//         rihanna: "BB",
//         "cristiano ronaldo": "PT",
//         drake: "CA",
//         beyonce: "US",
//         "celine dion": "CA",
//         eminem: "US",
//         "taylor swift": "US",
//         "ed sheeran": "GB",
//         adele: "GB",
//         messi: "AR",
//         "lionel messi": "AR",
//         asake: "NG",
//         davido: "NG",
//         "ayra starr": "NG",
//       };

//       // Normalize all cache keys
//       const normalizedCache = {};
//       for (const [key, value] of Object.entries(knownPeople)) {
//         normalizedCache[normalize(key)] = value;
//       }

//       console.log("üîç Looking for:", normalized);
//       console.log("üìö Cache keys:", Object.keys(normalizedCache));

//       // Check exact match first
//       if (normalizedCache[normalized]) {
//         console.log("‚úÖ FOUND IN CACHE:", normalizedCache[normalized]);
//         return { name, nationality: normalizedCache[normalized] };
//       }

//       console.log("‚ùå Not in cache, checking partial matches...");

//       // Check partial matches for known people
//       for (const [key, country] of Object.entries(normalizedCache)) {
//         if (normalized.includes(key) || key.includes(normalized)) {
//           console.log("‚úÖ PARTIAL MATCH:", key, "->", country);
//           return { name, nationality: country };
//         }
//       }

//       console.log("‚ö†Ô∏è No cache match, trying Claude API...");

//       // Use Claude API to search for nationality
//       try {
//         const response = await fetch("https://api.anthropic.com/v1/messages", {
//           method: "POST",
//           headers: {
//             "Content-Type": "application/json",
//             "anthropic-version": "2023-06-01",
//           },
//           body: JSON.stringify({
//             model: "claude-sonnet-4-20250514",
//             max_tokens: 1000,
//             tools: [
//               {
//                 type: "web_search_20250305",
//                 name: "web_search",
//               },
//             ],
//             messages: [
//               {
//                 role: "user",
//                 content: `Search for information about "${name}" and tell me their nationality. Respond with ONLY a two-letter ISO 3166-1 alpha-2 country code (examples: NG for Nigeria, US for United States, PT for Portugal, BB for Barbados, GB for United Kingdom). Do not include any other text, explanation, or punctuation - just the two letters.`,
//               },
//             ],
//           }),
//         });

//         const data = await response.json();
//         console.log("ü§ñ Claude API response:", JSON.stringify(data, null, 2));

//         // Extract text from all content blocks
//         if (data.content && Array.isArray(data.content)) {
//           let fullText = "";
//           for (const block of data.content) {
//             if (block.type === "text" && block.text) {
//               fullText += block.text + " ";
//             }
//           }

//           // Clean and extract country code
//           fullText = fullText.trim().toUpperCase();
//           console.log("üìÑ Extracted text:", fullText);

//           // Look for isolated 2-letter country code
//           const match = fullText.match(/\b([A-Z]{2})\b/);
//           if (match && match[1]) {
//             const code = match[1];
//             console.log("üåç Found country code:", code);
//             return { name, nationality: code };
//           }
//         }
//       } catch (err) {
//         console.error("‚ùå Claude API error:", err);
//       }

//       // Skip Nationalize.io for single names that are likely stage names
//       const isStageName = !name.includes(" ") && name.length < 15;

//       console.log(
//         "üé≠ Is stage name?",
//         isStageName,
//         "- Skip Nationalize.io?",
//         isStageName
//       );

//       if (!isStageName) {
//         console.log("üåê Trying Nationalize.io...");
//         try {
//           const url = `https://api.nationalize.io/?name=${encodeURIComponent(
//             name.split(" ")[0]
//           )}`;
//           const res = await fetch(url);
//           const data = await res.json();
//           console.log("üåê Nationalize.io response:", data);

//           if (data?.country?.length) {
//             console.log(
//               "‚ö†Ô∏è Using Nationalize.io result:",
//               data.country[0].country_id
//             );
//             return { name, nationality: data.country[0].country_id };
//           }
//         } catch (err) {
//           console.error("‚ùå Nationalize.io error:", err);
//         }
//       } else {
//         console.log("‚è≠Ô∏è Skipped Nationalize.io (stage name detected)");
//       }

//       console.log("‚ùì Returning Unknown");
//       return { name, nationality: "Unknown" };
//     },
//   },
// };

// export default resolvers;

// Log immediately to verify this file is being loaded

// WORKING CODE

// console.log("üîÑ Nationality resolver loaded at:", new Date().toISOString());

// const resolvers = {
//   Query: {
//     async getNationality(_, { name }) {
//       console.log("üéØ getNationality called with:", name);

//       // Normalize: lowercase, trim, remove accents/special chars
//       const normalize = (str) => {
//         return str
//           .toLowerCase()
//           .trim()
//           .normalize("NFD")
//           .replace(/[\u0300-\u036f]/g, ""); // Remove accents
//       };

//       const normalized = normalize(name);

//       // Remove common suffixes that users might add
//       const cleanedName = normalized
//         .replace(
//           /\b(singer|artist|rapper|musician|actor|actress|player|footballer)\b/g,
//           ""
//         )
//         .trim();

//       console.log("üìù Input:", `"${name}" -> cleaned: "${cleanedName}"`);

//       // Small cache for very common queries (optional - for speed)
//       const quickCache = {
//         rema: "NG",
//         wizkid: "NG",
//         tems: "NG",
//         "burna boy": "NG",
//         beyonce: "US",
//         drake: "CA",
//       };

//       // Check quick cache first
//       if (quickCache[cleanedName]) {
//         console.log("‚ö° Quick cache hit:", quickCache[cleanedName]);
//         return { name, nationality: quickCache[cleanedName] };
//       }

//       // Try API Ninjas Celebrity API
//       try {
//         console.log("üîç Searching API Ninjas...");

//         const apiKey = process.env.API_NINJAS_KEY;

//         if (!apiKey) {
//           console.log("‚ö†Ô∏è API_NINJAS_KEY not found in environment");
//         } else {
//           console.log("‚úì API key found, length:", apiKey.length);
//         }

//         const response = await fetch(
//           `https://api.api-ninjas.com/v1/celebrity?name=${encodeURIComponent(
//             cleanedName
//           )}`,
//           {
//             headers: {
//               "X-Api-Key": apiKey,
//             },
//           }
//         );

//         if (response.ok) {
//           const data = await response.json();
//           console.log("üìä API Ninjas response:", data);

//           if (data && data.length > 0) {
//             // Find the best match - prioritize singers/musicians if search term suggests music
//             const originalLower = name.toLowerCase();
//             const isMusicQuery =
//               originalLower.includes("singer") ||
//               originalLower.includes("musician") ||
//               originalLower.includes("rapper") ||
//               originalLower.includes("artist");

//             let celebrity = data[0]; // Default to first result

//             // If looking for music, find a musician
//             if (isMusicQuery || data.length > 1) {
//               const musician = data.find((c) =>
//                 c.occupation?.some(
//                   (occ) =>
//                     occ.includes("singer") ||
//                     occ.includes("musician") ||
//                     occ.includes("rapper")
//                 )
//               );
//               if (musician) {
//                 celebrity = musician;
//                 console.log("üéµ Found musician match:", celebrity.name);
//               }
//             }

//             const nationality = celebrity.nationality?.toUpperCase();

//             if (nationality) {
//               console.log("‚úÖ Found via API Ninjas:", nationality);
//               return { name, nationality };
//             }
//           }
//         } else {
//           console.log("‚ö†Ô∏è API Ninjas error:", response.status);
//         }
//       } catch (err) {
//         console.error("‚ùå API Ninjas error:", err.message);
//       }

//       // Fallback: Try MusicBrainz for musicians/singers
//       try {
//         console.log("üéµ Trying MusicBrainz (music database)...");

//         const mbUrl = `https://musicbrainz.org/ws/2/artist/?query=${encodeURIComponent(
//           cleanedName
//         )}&fmt=json&limit=5`;
//         const mbRes = await fetch(mbUrl, {
//           headers: {
//             "User-Agent": "NationalityFinder/1.0",
//           },
//         });

//         if (mbRes.ok) {
//           const mbData = await mbRes.json();
//           console.log(
//             "üéµ MusicBrainz found:",
//             mbData.artists?.length || 0,
//             "artists"
//           );

//           if (mbData.artists && mbData.artists.length > 0) {
//             // Get the first artist (most relevant)
//             const artist = mbData.artists[0];
//             console.log(
//               "üéµ Top match:",
//               artist.name,
//               "from",
//               artist.country || artist.area?.name
//             );

//             // MusicBrainz returns ISO country codes directly
//             const countryCode = artist.country;
//             if (countryCode && countryCode.length === 2) {
//               console.log("‚úÖ Found via MusicBrainz:", countryCode);
//               return { name, nationality: countryCode };
//             }

//             // Try to get country from area
//             if (artist.area?.name) {
//               const areaCode = getCountryCode(artist.area.name);
//               if (areaCode) {
//                 console.log("‚úÖ Found via MusicBrainz area:", areaCode);
//                 return { name, nationality: areaCode };
//               }
//             }
//           }
//         }
//       } catch (err) {
//         console.error("‚ùå MusicBrainz error:", err.message);
//       }

//       // Fallback: Try Wikipedia/Wikidata search
//       try {
//         console.log("üîç Trying Wikipedia/Wikidata...");

//         // Add context to search if it's a single name (likely an artist)
//         const searchTerm =
//           cleanedName.split(" ").length === 1
//             ? `${cleanedName} singer musician`
//             : cleanedName;

//         // Search Wikipedia
//         const searchUrl = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(
//           searchTerm
//         )}&format=json&origin=*`;
//         const searchRes = await fetch(searchUrl);
//         const searchData = await searchRes.json();

//         if (searchData.query?.search?.length > 0) {
//           const pageTitle = searchData.query.search[0].title;
//           console.log("üìÑ Found Wikipedia page:", pageTitle);

//           // Get page content
//           const pageUrl = `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(
//             pageTitle
//           )}&prop=extracts&exintro&explaintext&format=json&origin=*`;
//           const pageRes = await fetch(pageUrl);
//           const pageData = await pageRes.json();

//           const pages = pageData.query?.pages;
//           if (pages) {
//             const page = Object.values(pages)[0];
//             const extract = page.extract || "";

//             console.log(
//               "üìù Wikipedia extract preview:",
//               extract.substring(0, 200)
//             );

//             // Try to extract nationality from the intro text
//             const nationalityPatterns = [
//               /is an? ([A-Z][a-z]+) /,
//               /was an? ([A-Z][a-z]+) /,
//               /\(born.*in ([A-Z][a-z]+)\)/,
//               /from ([A-Z][a-z]+)/,
//             ];

//             for (const pattern of nationalityPatterns) {
//               const match = extract.match(pattern);
//               if (match) {
//                 const country = match[1];
//                 const countryCode = getCountryCode(country);
//                 if (countryCode) {
//                   console.log(
//                     "‚úÖ Found via Wikipedia:",
//                     countryCode,
//                     `(${country})`
//                   );
//                   return { name, nationality: countryCode };
//                 }
//               }
//             }
//           }
//         }
//       } catch (err) {
//         console.error("‚ùå Wikipedia error:", err.message);
//       }

//       // Last resort: Nationalize.io (only for multi-word names)
//       const isStageName = !name.includes(" ") && name.length < 15;

//       if (!isStageName) {
//         console.log("üåê Trying Nationalize.io...");
//         try {
//           const url = `https://api.nationalize.io/?name=${encodeURIComponent(
//             cleanedName.split(" ")[0]
//           )}`;
//           const res = await fetch(url);
//           const data = await res.json();

//           if (data?.country?.length) {
//             console.log(
//               "‚ö†Ô∏è Using Nationalize.io result:",
//               data.country[0].country_id
//             );
//             return { name, nationality: data.country[0].country_id };
//           }
//         } catch (err) {
//           console.error("‚ùå Nationalize.io error:", err);
//         }
//       } else {
//         console.log("‚è≠Ô∏è Skipped Nationalize.io (stage name detected)");
//       }

//       console.log("‚ùì Returning Unknown");
//       return { name, nationality: "Unknown" };
//     },
//   },
// };

// // Helper function to convert country names to ISO codes
// function getCountryCode(countryName) {
//   const countries = {
//     nigerian: "NG",
//     nigeria: "NG",
//     american: "US",
//     america: "US",
//     "united states": "US",
//     canadian: "CA",
//     canada: "CA",
//     british: "GB",
//     britain: "GB",
//     "united kingdom": "GB",
//     english: "GB",
//     portuguese: "PT",
//     portugal: "PT",
//     barbadian: "BB",
//     barbados: "BB",
//     argentinian: "AR",
//     argentina: "AR",
//     argentine: "AR",
//     norwegian: "NO",
//     norway: "NO",
//     colombian: "CO",
//     colombia: "CO",
//     spanish: "ES",
//     spain: "ES",
//     french: "FR",
//     france: "FR",
//     german: "DE",
//     germany: "DE",
//     italian: "IT",
//     italy: "IT",
//     brazilian: "BR",
//     brazil: "BR",
//     mexican: "MX",
//     mexico: "MX",
//   };

//   return countries[countryName.toLowerCase()];
// }

// export default resolvers;
//  WORKING CODE

// const resolvers = {
//   Query: {
//     async getNationality(_, { name }) {
//       console.log("üéØ getNationality called with:", name);

//       const normalize = (str) => {
//         return str
//           .toLowerCase()
//           .trim()
//           .normalize("NFD")
//           .replace(/[\u0300-\u036f]/g, "");
//       };

//       const normalized = normalize(name);
//       const cleanedName = normalized
//         .replace(
//           /\b(singer|artist|rapper|musician|actor|actress|player|footballer)\b/g,
//           ""
//         )
//         .trim();

//       console.log("üìù Input:", `"${name}" -> cleaned: "${cleanedName}"`);

//       // Quick cache with rich data
//       const quickCache = {
//         rema: {
//           name,
//           nationality: "NG",
//           fullName: "Divine Ikubor",
//           age: 24,
//           occupation: ["Singer", "Songwriter"],
//           photo: null,
//           bio: "Nigerian Afrobeats sensation known for 'Calm Down' and 'Iron Man'",
//         },
//         wizkid: {
//           name,
//           nationality: "NG",
//           fullName: "Ayodeji Ibrahim Balogun",
//           age: 34,
//           occupation: ["Singer", "Songwriter"],
//           photo: null,
//           bio: "Nigerian music superstar and international Afrobeats pioneer",
//         },
//         tems: {
//           name,
//           nationality: "NG",
//           fullName: "Temilade Openiyi",
//           age: 29,
//           occupation: ["Singer", "Songwriter"],
//           photo: null,
//           bio: "Nigerian artist who gained global recognition with 'Essence'",
//         },
//       };

//       if (quickCache[cleanedName]) {
//         console.log("‚ö° Quick cache hit");
//         return quickCache[cleanedName];
//       }

//       // Try API Ninjas Celebrity API
//       try {
//         console.log("üîç Searching API Ninjas...");

//         const apiKey = process.env.API_NINJAS_KEY;

//         if (!apiKey) {
//           console.log("‚ö†Ô∏è API_NINJAS_KEY not found in environment");
//         } else {
//           console.log("‚úì API key found");
//         }

//         const response = await fetch(
//           `https://api.api-ninjas.com/v1/celebrity?name=${encodeURIComponent(
//             cleanedName
//           )}`,
//           {
//             headers: {
//               "X-Api-Key": apiKey,
//             },
//           }
//         );

//         if (response.ok) {
//           const data = await response.json();
//           console.log("üìä API Ninjas response:", data);

//           if (data && data.length > 0) {
//             const originalLower = name.toLowerCase();
//             const isMusicQuery =
//               originalLower.includes("singer") ||
//               originalLower.includes("musician") ||
//               originalLower.includes("rapper") ||
//               originalLower.includes("artist");

//             let celebrity = data[0];

//             if (isMusicQuery || data.length > 1) {
//               const musician = data.find((c) =>
//                 c.occupation?.some(
//                   (occ) =>
//                     occ.includes("singer") ||
//                     occ.includes("musician") ||
//                     occ.includes("rapper")
//                 )
//               );
//               if (musician) {
//                 celebrity = musician;
//                 console.log("üéµ Found musician match:", celebrity.name);
//               }
//             }

//             const nationality = celebrity.nationality?.toUpperCase();

//             if (nationality) {
//               console.log("‚úÖ Found via API Ninjas:", nationality);

//               // Format occupations nicely
//               const occupations = celebrity.occupation
//                 ? celebrity.occupation
//                     .map((occ) =>
//                       occ
//                         .split("_")
//                         .map(
//                           (word) => word.charAt(0).toUpperCase() + word.slice(1)
//                         )
//                         .join(" ")
//                     )
//                     .filter((occ) => !occ.includes("Pornographic")) // Filter inappropriate
//                 : [];

//               return {
//                 name,
//                 nationality,
//                 fullName: celebrity.name,
//                 age: celebrity.age || null,
//                 occupation: occupations,
//                 photo: null,
//                 bio: `${celebrity.name} is known for ${
//                   occupations[0] || "their work"
//                 }`,
//               };
//             }
//           }
//         } else {
//           console.log("‚ö†Ô∏è API Ninjas error:", response.status);
//         }
//       } catch (err) {
//         console.error("‚ùå API Ninjas error:", err.message);
//       }

//       // Try MusicBrainz
//       try {
//         console.log("üéµ Trying MusicBrainz...");

//         const mbUrl = `https://musicbrainz.org/ws/2/artist/?query=${encodeURIComponent(
//           cleanedName
//         )}&fmt=json&limit=5`;
//         const mbRes = await fetch(mbUrl, {
//           headers: {
//             "User-Agent": "NationalityFinder/1.0",
//           },
//         });

//         if (mbRes.ok) {
//           const mbData = await mbRes.json();
//           console.log(
//             "üéµ MusicBrainz found:",
//             mbData.artists?.length || 0,
//             "artists"
//           );

//           if (mbData.artists && mbData.artists.length > 0) {
//             const artist = mbData.artists[0];
//             console.log(
//               "üéµ Top match:",
//               artist.name,
//               "from",
//               artist.country || artist.area?.name
//             );

//             const countryCode = artist.country;
//             if (countryCode && countryCode.length === 2) {
//               console.log("‚úÖ Found via MusicBrainz:", countryCode);

//               // Calculate age from life-span if available
//               let age = null;
//               if (artist["life-span"]?.begin) {
//                 const birthYear = parseInt(artist["life-span"].begin);
//                 if (!isNaN(birthYear)) {
//                   age = new Date().getFullYear() - birthYear;
//                 }
//               }

//               return {
//                 name,
//                 nationality: countryCode,
//                 fullName: artist.name,
//                 age,
//                 occupation: ["Musician", "Artist"],
//                 photo: null,
//                 bio: artist.disambiguation
//                   ? `${artist.name} - ${artist.disambiguation}`
//                   : null,
//               };
//             }

//             if (artist.area?.name) {
//               const areaCode = getCountryCode(artist.area.name);
//               if (areaCode) {
//                 console.log("‚úÖ Found via MusicBrainz area:", areaCode);
//                 return {
//                   name,
//                   nationality: areaCode,
//                   fullName: artist.name,
//                   age: null,
//                   occupation: ["Musician", "Artist"],
//                   photo: null,
//                   bio: artist.disambiguation || null,
//                 };
//               }
//             }
//           }
//         }
//       } catch (err) {
//         console.error("‚ùå MusicBrainz error:", err.message);
//       }

//       // Try Wikipedia
//       try {
//         console.log("üîç Trying Wikipedia...");

//         const searchTerm =
//           cleanedName.split(" ").length === 1
//             ? `${cleanedName} singer musician`
//             : cleanedName;

//         const searchUrl = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(
//           searchTerm
//         )}&format=json&origin=*`;
//         const searchRes = await fetch(searchUrl);
//         const searchData = await searchRes.json();

//         if (searchData.query?.search?.length > 0) {
//           const pageTitle = searchData.query.search[0].title;
//           console.log("üìÑ Found Wikipedia page:", pageTitle);

//           const pageUrl = `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(
//             pageTitle
//           )}&prop=extracts&exintro&explaintext&format=json&origin=*`;
//           const pageRes = await fetch(pageUrl);
//           const pageData = await pageRes.json();

//           const pages = pageData.query?.pages;
//           if (pages) {
//             const page = Object.values(pages)[0];
//             const extract = page.extract || "";

//             console.log(
//               "üìù Wikipedia extract preview:",
//               extract.substring(0, 200)
//             );

//             const nationalityPatterns = [
//               /is an? ([A-Z][a-z]+) /,
//               /was an? ([A-Z][a-z]+) /,
//               /\(born.*in ([A-Z][a-z]+)\)/,
//               /from ([A-Z][a-z]+)/,
//             ];

//             for (const pattern of nationalityPatterns) {
//               const match = extract.match(pattern);
//               if (match) {
//                 const country = match[1];
//                 const countryCode = getCountryCode(country);
//                 if (countryCode) {
//                   console.log(
//                     "‚úÖ Found via Wikipedia:",
//                     countryCode,
//                     `(${country})`
//                   );

//                   // Extract bio (first 2 sentences)
//                   const sentences = extract.split(". ");
//                   const bio =
//                     sentences.slice(0, 2).join(". ") +
//                     (sentences.length > 2 ? "." : "");

//                   return {
//                     name,
//                     nationality: countryCode,
//                     fullName: pageTitle,
//                     age: null,
//                     occupation: [],
//                     photo: null,
//                     bio: bio.length < 300 ? bio : bio.substring(0, 297) + "...",
//                   };
//                 }
//               }
//             }
//           }
//         }
//       } catch (err) {
//         console.error("‚ùå Wikipedia error:", err.message);
//       }

//       // Nationalize.io fallback
//       const isStageName = !name.includes(" ") && name.length < 15;

//       if (!isStageName) {
//         console.log("üåê Trying Nationalize.io...");
//         try {
//           const url = `https://api.nationalize.io/?name=${encodeURIComponent(
//             cleanedName.split(" ")[0]
//           )}`;
//           const res = await fetch(url);
//           const data = await res.json();

//           if (data?.country?.length) {
//             console.log(
//               "‚ö†Ô∏è Using Nationalize.io result:",
//               data.country[0].country_id
//             );
//             return {
//               name,
//               nationality: data.country[0].country_id,
//               fullName: null,
//               age: null,
//               occupation: [],
//               photo: null,
//               bio: null,
//             };
//           }
//         } catch (err) {
//           console.error("‚ùå Nationalize.io error:", err);
//         }
//       }

//       console.log("‚ùì Returning Unknown");
//       return {
//         name,
//         nationality: "Unknown",
//         fullName: null,
//         age: null,
//         occupation: [],
//         photo: null,
//         bio: null,
//       };
//     },
//   },
// };

// function getCountryCode(countryName) {
//   const countries = {
//     nigerian: "NG",
//     nigeria: "NG",
//     american: "US",
//     america: "US",
//     "united states": "US",
//     canadian: "CA",
//     canada: "CA",
//     british: "GB",
//     britain: "GB",
//     "united kingdom": "GB",
//     english: "GB",
//     portuguese: "PT",
//     portugal: "PT",
//     barbadian: "BB",
//     barbados: "BB",
//     argentinian: "AR",
//     argentina: "AR",
//     argentine: "AR",
//     norwegian: "NO",
//     norway: "NO",
//     colombian: "CO",
//     colombia: "CO",
//     spanish: "ES",
//     spain: "ES",
//     french: "FR",
//     france: "FR",
//     german: "DE",
//     germany: "DE",
//     italian: "IT",
//     italy: "IT",
//     brazilian: "BR",
//     brazil: "BR",
//     mexican: "MX",
//     mexico: "MX",
//   };

//   return countries[countryName.toLowerCase()];
// }

// export default resolvers;
// const resolvers = {
//   Query: {
//     async getNationality(_, { name }) {
//       console.log("üéØ getNationality called with:", name);

//       const normalize = (str) => {
//         return str
//           .toLowerCase()
//           .trim()
//           .normalize("NFD")
//           .replace(/[\u0300-\u036f]/g, "");
//       };

//       const normalized = normalize(name);
//       const cleanedName = normalized
//         .replace(
//           /\b(singer|artist|rapper|musician|actor|actress|player|footballer)\b/g,
//           ""
//         )
//         .trim();

//       console.log("üìù Input:", `"${name}" -> cleaned: "${cleanedName}"`);

//       // Quick cache with rich data
//       const quickCache = {
//         rema: {
//           name,
//           nationality: "NG",
//           fullName: "Divine Ikubor",
//           age: 24,
//           occupation: ["Singer", "Songwriter"],
//           photo: null,
//           bio: "Nigerian Afrobeats sensation known for 'Calm Down' and 'Iron Man'",
//         },
//         wizkid: {
//           name,
//           nationality: "NG",
//           fullName: "Ayodeji Ibrahim Balogun",
//           age: 34,
//           occupation: ["Singer", "Songwriter"],
//           photo: null,
//           bio: "Nigerian music superstar and international Afrobeats pioneer",
//         },
//         tems: {
//           name,
//           nationality: "NG",
//           fullName: "Temilade Openiyi",
//           age: 29,
//           occupation: ["Singer", "Songwriter"],
//           photo: null,
//           bio: "Nigerian artist who gained global recognition with 'Essence'",
//         },
//       };

//       if (quickCache[cleanedName]) {
//         console.log(`‚ö° Quick cache hit`);
//         return quickCache[cleanedName];
//       }
//       console.log("Loaded KEY:", process.env.API_NINJAS_KEY);

//       // Try API Ninjas Celebrity API
//       try {
//         console.log("üîç Searching API Ninjas...");
//         console.log("Loaded KEY:", process.env.API_NINJAS_KEY);

//         const apiKey = process.env.API_NINJAS_KEY;

//         if (!apiKey) {
//           console.log("‚ö†Ô∏è API_NINJAS_KEY not found in environment");
//         } else {
//           console.log("‚úì API key found");
//         }

//         const response = await fetch(
//           `https://api.api-ninjas.com/v1/celebrity?name=${encodeURIComponent(
//             cleanedName
//           )}`,
//           {
//             headers: {
//               "X-Api-Key": apiKey,
//             },
//           }
//         );

//         if (response.ok) {
//           const data = await response.json();
//           console.log("üìä API Ninjas response:", data);

//           if (data && data.length > 0) {
//             const originalLower = name.toLowerCase();
//             const isMusicQuery =
//               originalLower.includes("singer") ||
//               originalLower.includes("musician") ||
//               originalLower.includes("rapper") ||
//               originalLower.includes("artist");

//             let celebrity = data[0];

//             if (isMusicQuery || data.length > 1) {
//               const musician = data.find((c) =>
//                 c.occupation?.some(
//                   (occ) =>
//                     occ.includes("singer") ||
//                     occ.includes("musician") ||
//                     occ.includes("rapper")
//                 )
//               );
//               if (musician) {
//                 celebrity = musician;
//                 console.log(
//                   "üéµ Found musician match:",
//                   celebrity,
//                   celebrity.name
//                 );
//               }
//             }

//             const nationality = celebrity.nationality?.toUpperCase();

//             if (nationality) {
//               console.log("‚úÖ Found via API Ninjas:", nationality);

//               // Format occupations nicely
//               const occupations = celebrity.occupation
//                 ? celebrity.occupation
//                     .map((occ) =>
//                       occ
//                         .split("_")
//                         .map(
//                           (word) => word.charAt(0).toUpperCase() + word.slice(1)
//                         )
//                         .join(" ")
//                     )
//                     .filter((occ) => !occ.includes("Pornographic")) // Filter inappropriate
//                 : [];

//               return {
//                 name,
//                 nationality,
//                 fullName: celebrity.name,
//                 age: celebrity.age || null,
//                 occupation: occupations,
//                 photo: null,
//                 bio: `${celebrity.name} is known for ${
//                   occupations[0] || "their work"
//                 }`,
//               };
//             }
//           }
//         } else {
//           console.log("‚ö†Ô∏è API Ninjas error:", response.status);
//         }
//       } catch (err) {
//         console.error("‚ùå API Ninjas error:", err.message);
//       }

//       // Try MusicBrainz
//       try {
//         console.log("üéµ Trying MusicBrainz...");

//         const mbUrl = `https://musicbrainz.org/ws/2/artist/?query=${encodeURIComponent(
//           cleanedName
//         )}&fmt=json&limit=5`;
//         const mbRes = await fetch(mbUrl, {
//           headers: {
//             "User-Agent": "NationalityFinder/1.0",
//           },
//         });

//         if (mbRes.ok) {
//           const mbData = await mbRes.json();
//           console.log(
//             "üéµ MusicBrainz found:",
//             mbData.artists?.length || 0,
//             "artists"
//           );

//           if (mbData.artists && mbData.artists.length > 0) {
//             const artist = mbData.artists[0];
//             console.log(
//               "üéµ Top match:",
//               artist.name,
//               "from",
//               artist.country || artist.area?.name
//             );

//             const countryCode = artist.country;
//             if (countryCode && countryCode.length === 2) {
//               console.log("‚úÖ Found via MusicBrainz:", countryCode);

//               // Calculate age from life-span if available
//               let age = null;
//               if (artist["life-span"]?.begin) {
//                 const birthYear = parseInt(artist["life-span"].begin);
//                 if (!isNaN(birthYear)) {
//                   age = new Date().getFullYear() - birthYear;
//                 }
//               }

//               return {
//                 name,
//                 nationality: countryCode,
//                 fullName: artist.name,
//                 age,
//                 occupation: ["Musician", "Artist"],
//                 photo: null,
//                 bio: artist.disambiguation
//                   ? `${artist.name} - ${artist.disambiguation}`
//                   : null,
//               };
//             }

//             if (artist.area?.name) {
//               const areaCode = getCountryCode(artist.area.name);
//               if (areaCode) {
//                 console.log("‚úÖ Found via MusicBrainz area:", areaCode);
//                 return {
//                   name,
//                   nationality: areaCode,
//                   fullName: artist.name,
//                   age: null,
//                   occupation: ["Musician", "Artist"],
//                   photo: null,
//                   bio: artist.disambiguation || null,
//                 };
//               }
//             }
//           }
//         }
//       } catch (err) {
//         console.error("‚ùå MusicBrainz error:", err.message);
//       }

//       // Try Wikipedia
//       try {
//         console.log("üîç Trying Wikipedia...");

//         const searchTerm =
//           cleanedName.split(" ").length === 1
//             ? `${cleanedName} singer musician`
//             : cleanedName;

//         const searchUrl = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(
//           searchTerm
//         )}&format=json&origin=*`;
//         const searchRes = await fetch(searchUrl);
//         const searchData = await searchRes.json();

//         if (searchData.query?.search?.length > 0) {
//           const pageTitle = searchData.query.search[0].title;
//           console.log("üìÑ Found Wikipedia page:", pageTitle);

//           const pageUrl = `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(
//             pageTitle
//           )}&prop=extracts&exintro&explaintext&format=json&origin=*`;
//           const pageRes = await fetch(pageUrl);
//           const pageData = await pageRes.json();

//           const pages = pageData.query?.pages;
//           if (pages) {
//             const page = Object.values(pages)[0];
//             const extract = page.extract || "";

//             console.log(
//               "üìù Wikipedia extract preview:",
//               extract.substring(0, 200)
//             );

//             const nationalityPatterns = [
//               /is an? ([A-Z][a-z]+) /,
//               /was an? ([A-Z][a-z]+) /,
//               /\(born.*in ([A-Z][a-z]+)\)/,
//               /from ([A-Z][a-z]+)/,
//             ];

//             for (const pattern of nationalityPatterns) {
//               const match = extract.match(pattern);
//               if (match) {
//                 const country = match[1];
//                 const countryCode = getCountryCode(country);
//                 if (countryCode) {
//                   console.log(
//                     "‚úÖ Found via Wikipedia:",
//                     countryCode,
//                     `(${country})`
//                   );

//                   // Extract bio (first 2 sentences)
//                   const sentences = extract.split(". ");
//                   const bio =
//                     sentences.slice(0, 2).join(". ") +
//                     (sentences.length > 2 ? "." : "");

//                   return {
//                     name,
//                     nationality: countryCode,
//                     fullName: pageTitle,
//                     age: null,
//                     occupation: [],
//                     photo: null,
//                     bio: bio.length < 300 ? bio : bio.substring(0, 297) + "...",
//                   };
//                 }
//               }
//             }
//           }
//         }
//       } catch (err) {
//         console.error("‚ùå Wikipedia error:", err.message);
//       }

//       // Nationalize.io fallback
//       const isStageName = !name.includes(" ") && name.length < 15;

//       if (!isStageName) {
//         console.log("üåê Trying Nationalize.io...");
//         try {
//           const url = `https://api.nationalize.io/?name=${encodeURIComponent(
//             cleanedName.split(" ")[0]
//           )}`;
//           const res = await fetch(url);
//           const data = await res.json();

//           if (data?.country?.length) {
//             console.log(
//               "‚ö†Ô∏è Using Nationalize.io result:",
//               data.country[0].country_id
//             );
//             return {
//               name,
//               nationality: data.country[0].country_id,
//               fullName: null,
//               age: null,
//               occupation: [],
//               photo: null,
//               bio: null,
//             };
//           }
//         } catch (err) {
//           console.error("‚ùå Nationalize.io error:", err);
//         }
//       }

//       console.log("‚ùì Returning Unknown");
//       return {
//         name,
//         nationality: "Unknown",
//         fullName: null,
//         age: null,
//         occupation: [],
//         photo: null,
//         bio: null,
//       };
//     },
//   },
// };

// function getCountryCode(countryName) {
//   const countries = {
//     nigerian: "NG",
//     nigeria: "NG",
//     american: "US",
//     america: "US",
//     "united states": "US",
//     canadian: "CA",
//     canada: "CA",
//     british: "GB",
//     britain: "GB",
//     "united kingdom": "GB",
//     english: "GB",
//     portuguese: "PT",
//     portugal: "PT",
//     barbadian: "BB",
//     barbados: "BB",
//     argentinian: "AR",
//     argentina: "AR",
//     argentine: "AR",
//     norwegian: "NO",
//     norway: "NO",
//     colombian: "CO",
//     colombia: "CO",
//     spanish: "ES",
//     spain: "ES",
//     french: "FR",
//     france: "FR",
//     german: "DE",
//     germany: "DE",
//     italian: "IT",
//     italy: "IT",
//     brazilian: "BR",
//     brazil: "BR",
//     mexican: "MX",
//     mexico: "MX",
//   };

//   return countries[countryName.toLowerCase()];
// }

// export default resolvers;
// const resolvers = {
//   Query: {
//     async getNationality(_, { name }) {
//       console.log("üéØ getNationality called with:", name);

//       const normalize = (str) => {
//         return str
//           .toLowerCase()
//           .trim()
//           .normalize("NFD")
//           .replace(/[\u0300-\u036f]/g, "");
//       };

//       const normalized = normalize(name);
//       const cleanedName = normalized
//         .replace(
//           /\b(singer|artist|rapper|musician|actor|actress|player|footballer)\b/g,
//           ""
//         )
//         .trim();

//       console.log("üìù Input:", `"${name}" -> cleaned: "${cleanedName}"`);

//       // Quick cache
//       const quickCache = {
//         rema: {
//           name,
//           nationality: "NG",
//           fullName: "Divine Ikubor",
//           age: 24,
//           occupation: ["Singer", "Songwriter"],
//           photo: null,
//           bio: "Nigerian Afrobeats sensation known for 'Calm Down' and 'Iron Man'",
//         },
//         wizkid: {
//           name,
//           nationality: "NG",
//           fullName: "Ayodeji Ibrahim Balogun",
//           age: 34,
//           occupation: ["Singer", "Songwriter"],
//           photo: null,
//           bio: "Nigerian music superstar and international Afrobeats pioneer",
//         },
//         tems: {
//           name,
//           nationality: "NG",
//           fullName: "Temilade Openiyi",
//           age: 29,
//           occupation: ["Singer", "Songwriter"],
//           photo: null,
//           bio: "Nigerian artist who gained global recognition with 'Essence'",
//         },
//       };

//       if (quickCache[cleanedName]) {
//         console.log(`‚ö° Quick cache hit`);
//         return quickCache[cleanedName];
//       }

//       console.log("Loaded KEY:", process.env.API_NINJAS_KEY);

//       // ----------------------------------------
//       // 1. API NINJAS
//       // ----------------------------------------
//       try {
//         console.log("üîç Searching API Ninjas...");
//         const apiKey = process.env.API_NINJAS_KEY;

//         if (!apiKey) {
//           console.log("‚ö†Ô∏è API_NINJAS_KEY not found in environment");
//         } else {
//           console.log("‚úì API key found");
//         }

//         const response = await fetch(
//           `https://api.api-ninjas.com/v1/celebrity?name=${encodeURIComponent(
//             cleanedName
//           )}`,
//           { headers: { "X-Api-Key": apiKey } }
//         );

//         if (response.ok) {
//           const data = await response.json();
//           console.log("üìä API Ninjas response:", data);

//           if (data && data.length > 0) {
//             let celeb = data[0];

//             // Choose musician if mixed results
//             const originalLower = name.toLowerCase();
//             const isMusicQuery =
//               originalLower.includes("singer") ||
//               originalLower.includes("musician") ||
//               originalLower.includes("rapper") ||
//               originalLower.includes("artist");

//             if (isMusicQuery || data.length > 1) {
//               const musician = data.find((c) =>
//                 c.occupation?.some(
//                   (occ) =>
//                     occ.includes("singer") ||
//                     occ.includes("musician") ||
//                     occ.includes("rapper")
//                 )
//               );
//               if (musician) celeb = musician;
//             }

//             const nationality = celeb.nationality?.toUpperCase();
//             if (nationality) {
//               console.log("‚úÖ Found via API Ninjas:", nationality);

//               // Format occupations
//               const occupations = celeb.occupation
//                 ? celeb.occupation.map((occ) =>
//                     occ
//                       .split("_")
//                       .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
//                       .join(" ")
//                   )
//                 : [];

//               // ADD THIS: Get photo from Wikipedia (free, fast, reliable)
//               // ADD PHOTO FROM WIKIPEDIA
//               let photoUrl = null;
//               try {
//                 const wikiSearch = await fetch(
//                   `https://en.wikipedia.org/w/api.php?action=query&prop=pageimages&format=json&piprop=original&titles=${encodeURIComponent(
//                     celeb.name
//                   )}&origin=*`
//                 );
//                 const wikiData = await wikiSearch.json();
//                 const pages = wikiData.query?.pages;
//                 if (pages) {
//                   const page = Object.values(pages)[0];
//                   if (page.original?.source) {
//                     photoUrl = page.original.source;
//                     console.log("Photo found:", photoUrl);
//                   }
//                 }
//               } catch (e) {
//                 console.log("No photo found on Wikipedia");
//               }

//               // Then in your return:
//               return {
//                 name,
//                 nationality,
//                 fullName: celeb.name,
//                 age: celeb.age || null,
//                 occupation: occupations,
//                 photo: photoUrl,
//                 bio: `${celeb.name} is known for ${
//                   occupations[0] || "their work"
//                 }.`,
//               };
//             }
//           }
//         } else {
//           console.log("‚ö†Ô∏è API Ninjas error:", response.status);
//         }
//       } catch (err) {
//         console.error("‚ùå API Ninjas error:", err.message);
//       }

//       // ----------------------------------------
//       // 2. MUSICBRAINZ
//       // ----------------------------------------
//       try {
//         console.log("üéµ Trying MusicBrainz...");

//         const mbUrl = `https://musicbrainz.org/ws/2/artist/?query=${encodeURIComponent(
//           cleanedName
//         )}&fmt=json&limit=5`;

//         const mbRes = await fetch(mbUrl, {
//           headers: { "User-Agent": "NationalityFinder/1.0" },
//         });

//         if (mbRes.ok) {
//           const mbData = await mbRes.json();
//           console.log(
//             "üéµ MusicBrainz found:",
//             mbData.artists?.length || 0,
//             "artists"
//           );

//           if (mbData.artists && mbData.artists.length > 0) {
//             const artist = mbData.artists[0];
//             const countryCode = artist.country;

//             if (countryCode) {
//               console.log("‚úÖ Found via MusicBrainz:", countryCode);

//               let age = null;
//               if (artist["life-span"]?.begin) {
//                 const birthYear = parseInt(artist["life-span"].begin);
//                 if (!isNaN(birthYear)) {
//                   age = new Date().getFullYear() - birthYear;
//                 }
//               }

//               return {
//                 name,
//                 nationality: countryCode,
//                 fullName: artist.name,
//                 age,
//                 occupation: ["Musician", "Artist"],
//                 photo: null,
//                 bio: artist.disambiguation || null,
//               };
//             }
//           }
//         }
//       } catch (err) {
//         console.error("‚ùå MusicBrainz error:", err.message);
//       }

//       // ----------------------------------------
//       // 3. WIKIPEDIA
//       // ----------------------------------------
//       try {
//         console.log("üîç Trying Wikipedia...");

//         const searchTerm =
//           cleanedName.split(" ").length === 1
//             ? `${cleanedName} singer musician`
//             : cleanedName;

//         const searchUrl = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(
//           searchTerm
//         )}&format=json&origin=*`;

//         const searchRes = await fetch(searchUrl);
//         const searchData = await searchRes.json();

//         if (searchData.query?.search?.length > 0) {
//           const pageTitle = searchData.query.search[0].title;
//           console.log("üìÑ Found Wikipedia page:", pageTitle);

//           const pageUrl = `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(
//             pageTitle
//           )}&prop=extracts&exintro&explaintext&format=json&origin=*`;

//           const pageRes = await fetch(pageUrl);
//           const pageData = await pageRes.json();

//           const pages = pageData.query?.pages;
//           if (pages) {
//             const page = Object.values(pages)[0];
//             const extract = page.extract || "";

//             const nationalityPatterns = [
//               /is an? ([A-Z][a-z]+) /,
//               /was an? ([A-Z][a-z]+) /,
//               /\(born.*in ([A-Z][a-z]+)\)/,
//               /from ([A-Z][a-z]+)/,
//             ];

//             for (const pattern of nationalityPatterns) {
//               const match = extract.match(pattern);
//               if (match) {
//                 const country = match[1];
//                 const countryCode = getCountryCode(country);

//                 if (countryCode) {
//                   const sentences = extract.split(". ");
//                   const bio = sentences.slice(0, 2).join(". ") + ".";

//                   return {
//                     name,
//                     nationality: countryCode,
//                     fullName: pageTitle,
//                     age: null,
//                     occupation: [],
//                     photo: null,
//                     bio,
//                   };
//                 }
//               }
//             }
//           }
//         }
//       } catch (err) {
//         console.error("‚ùå Wikipedia error:", err.message);
//       }

//       // ----------------------------------------
//       // 4. NATIONALIZE.IO FALLBACK
//       // ----------------------------------------
//       const isStageName = !name.includes(" ") && name.length < 15;

//       if (!isStageName) {
//         console.log("üåê Trying Nationalize.io...");
//         try {
//           const url = `https://api.nationalize.io/?name=${encodeURIComponent(
//             cleanedName.split(" ")[0]
//           )}`;
//           const res = await fetch(url);
//           const data = await res.json();

//           if (data?.country?.length) {
//             return {
//               name,
//               nationality: data.country[0].country_id,
//               fullName: null,
//               age: null,
//               occupation: [],
//               photo: null,
//               bio: null,
//             };
//           }
//         } catch (err) {
//           console.error("‚ùå Nationalize.io error:", err);
//         }
//       }

//       // ----------------------------------------
//       // FALLBACK
//       // ----------------------------------------
//       return {
//         name,
//         nationality: "Unknown",
//         fullName: null,
//         age: null,
//         occupation: [],
//         photo: null,
//         bio: null,
//       };
//     },
//   },
// };

// // -------------------------
// function getCountryCode(countryName) {
//   const countries = {
//     nigerian: "NG",
//     nigeria: "NG",
//     american: "US",
//     america: "US",
//     "united states": "US",
//     canadian: "CA",
//     canada: "CA",
//     british: "GB",
//     britain: "GB",
//     "united kingdom": "GB",
//     english: "GB",
//     portuguese: "PT",
//     portugal: "PT",
//     barbadian: "BB",
//     barbados: "BB",
//     argentinian: "AR",
//     argentina: "AR",
//     argentine: "AR",
//     norwegian: "NO",
//     norway: "NO",
//     colombian: "CO",
//     colombia: "CO",
//     spanish: "ES",
//     spain: "ES",
//     french: "FR",
//     france: "FR",
//     german: "DE",
//     germany: "DE",
//     italian: "IT",
//     italy: "IT",
//     brazilian: "BR",
//     brazil: "BR",
//     mexican: "MX",
//     mexico: "MX",
//   };

//   return countries[countryName.toLowerCase()];
// }

// export default resolvers;
// src/resolvers.js
// import fetch from "node-fetch";
